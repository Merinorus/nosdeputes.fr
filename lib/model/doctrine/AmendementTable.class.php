<?php
/**
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class AmendementTable extends Doctrine_Table
{

  public function findLastOneByLegisLoiNum($legis, $loi, $numero) {
    $lois = array($loi);
    if (substr($loi, 0, 2) == "TA") {
      $lois[] = str_replace("TA", "TA0", $loi);
      $lois[] = str_replace("TA", "TA00", $loi);
      $lois[] = str_replace("TA", "TA000", $loi);
      $lois[] = str_replace("TA000", "TA", $loi);
      $lois[] = str_replace("TA00", "TA", $loi);
      $lois[] = str_replace("TA0", "TA", $loi);
    }
    $query = $this->createQuery('a')
      ->where('a.legislature = ?', $legis)
      ->andWhereIn('a.texteloi_id', $lois)
      ->andWhere('a.numero = ?', $numero)
      ->andWhere('a.sort != ?', "RectifiÃ©");
    return $query->fetchOne();
  }

  public function findOneByLegisLoiNumRect($legis, $loi, $numero, $rect) {
    $query = $this->createQuery('a')
      ->where('a.legislature = ?', $legis)
      ->andWhere('a.texteloi_id = ?', $loi)
      ->andWhere('a.numero = ?', $numero)
      ->andWhere('a.rectif = ?', $rect);
    return $query->fetchOne();
  }

  public function findByCleanedSource($source) {
    $sources = array();
    $sources[] = $source;
    $query = $this->createQuery('a');
    if (strpos($source, '/AN/') !== false) {
      $sources[] = preg_replace('/\/AN\//', '/', $source);
    }
    if (strpos($source, '/dyn/') !== false) {
      $sources[] = preg_replace('/\/dyn\//', '/', $source).".asp";
    } else {
      $sources[] = preg_replace('/nationale.fr\/(.*)\.asp/', 'nationale.fr/dyn/\\1', $source);
    }
    $query->whereIn('a.source', $sources);
    return $query->execute();
  }

}
